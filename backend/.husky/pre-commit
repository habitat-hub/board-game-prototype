#!/usr/bin/env bash

# Fail fast: exit on error, unset vars, and failed pipes
set -euo pipefail

STAGED_FILES=$(git diff --cached --name-only)

# Run lint and format for frontend if staged changes exist
if echo "$STAGED_FILES" | grep -q '^frontend/'; then
  echo "ðŸ”§ Running lint:fix and format in frontend"
  cd frontend
  npm run lint:fix
  npm run format
  cd ..
  git add frontend
fi

# Run lint, format, and documentation generation for backend if staged changes exist (excluding husky config changes)
if echo "$STAGED_FILES" | grep -q '^backend/'; then
  if ! echo "$STAGED_FILES" | grep -q '^backend/.husky'; then
    echo "ðŸ”§ Running lint:fix, format, and docs generation in backend"
    cd backend
    npm run lint:fix
    npm run format
    npm run generate-erd && npm run redoc && npm run generate-api-types
    cd ..
    git add backend

    if [ -f "docs/index.html" ]; then
      git add docs/index.html
      echo "âœ¨ Added docs/index.html to staging"
    fi

    for file in frontend/src/api/types/*; do
      if [ -f "$file" ]; then
        git add "$file"
        echo "âœ¨ Added $file to staging"
      fi
    done
  fi
fi

# Ensure a clean success status when reached (failures exit earlier)
true
