# データベースシーディング

このドキュメントでは、RBACシステムに必要なロールと権限の初期データを設定するシーディングシステムについて説明します。

## 概要

- **自動シーディング**: アプリケーション起動時に自動的に実行される
- **本番環境対応**: 本番環境でも安全に実行され、既存データを保護
- **冪等性**: 何度実行しても同じ結果となり、既存データは変更されない
- **環境依存**: 開発環境と本番環境で異なる動作を提供

## シーディングの仕組み

### 1. 自動実行 (推奨)

アプリケーション起動時に自動的にチェックと実行が行われます：

```bash
npm run dev    # 開発環境
npm start      # 本番環境
```

**動作フロー:**

1. データベース接続確立
2. ロール・権限・マッピングテーブルのデータ数をチェック
3. データが不足している場合のみシーディングを実行
4. 安全なsync設定を使用（`force: false, alter: false`）

### 2. 手動実行

**開発環境での手動実行:**

```bash
# 通常のシーディング
npm run seed

# 強制シーディング（既存データをクリア）
npm run seed:force

# シーディング結果の検証
npm run seed:verify
```

## 環境別の動作

### 開発環境・本番環境共通

- シーディング失敗時: アプリケーションが終了
- データベーススキーマ: 既存構造を保護（`force: false, alter: false`）
- エラーハンドリング: 厳密

シーディングが失敗した場合、アプリケーションは正常に起動できません。これにより、データベースの整合性を確保します。

## シードデータの内容

### ロール（Roles）

- `admin` - Admin（全権限）
- `editor` - Editor（読み書き権限）
- `viewer` - Viewer（読み取り権限のみ）

### 権限（Permissions）

- プロジェクト関連

  - `read_project` - プロジェクトの閲覧
  - `write_project` - プロジェクトの編集
  - `delete_project` - プロジェクトの削除
  - `manage_project` - プロジェクトの管理

- プロトタイプ関連

  - `read_prototype` - プロトタイプの閲覧
  - `write_prototype` - プロトタイプの編集
  - `delete_prototype` - プロトタイプの削除

- ユーザー管理関連
  - `read_user` - ユーザー情報の閲覧
  - `manage_user` - ユーザー管理

### トラブルシューティング

データベース関連のエラーが発生した場合:

1. **データベース権限の確認**

   - CREATE権限
   - INSERT権限
   - SELECT権限

2. **データベース接続の確認**

   - DATABASE_URL環境変数
   - ネットワーク接続
   - データベースサーバーの状態

3. **ログの確認**

   - アプリケーション起動ログ
   - データベースエラーログ

4. **シード検証**
   ```bash
   npm run seed:verify
   ```

### よくあるエラーと対処法

- **テーブル作成エラー**: データベースユーザーのCREATE権限を確認
- **外部キー制約エラー**: シーディング順序を確認
- **接続タイムアウト**: ネットワーク設定とファイアウォールを確認
- **初期化失敗**: `npm run seed:force` で強制再作成（開発環境のみ）

## 新しいシードファイルの追加

新しいシードファイルを追加する場合：

1. `src/database/seeders/` に `002-example.ts` のような番号付きファイルを作成
2. `src/database/seeders/index.ts` でシードを呼び出し
3. シードファイルは冪等性（何度実行しても同じ結果）を保つこと
4. 本番環境での安全性を考慮した実装にすること

## 注意事項

- サーバー起動時に自動的にシードが実行されます
- `seed:force` は**全データを削除**するため、本番環境では絶対に使用しないでください
